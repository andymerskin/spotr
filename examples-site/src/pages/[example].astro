---
import Layout from '../layouts/Layout.astro';
import Sidebar from '../components/Sidebar.astro';
import FrameworkTabs from '../components/FrameworkTabs.astro';
import StackBlitzEmbed from '../components/StackBlitzEmbed.astro';
import { examples } from '../data/examples';

export function getStaticPaths() {
  return examples.map((ex) => ({ params: { example: ex.slug } }));
}

const { example } = Astro.params;
const framework = Astro.url.searchParams.get('framework') ?? 'react';

const validExample = examples.find((e) => e.slug === example) ?? examples[0];
const exampleSlug = example ?? validExample.slug;
const exampleTitle = validExample.title;
---

<Layout title={exampleTitle}>
  <div class="flex min-h-screen bg-neutral-900">
    <Sidebar currentExample={exampleSlug} />
    <main class="ml-60 flex-1 p-8">
      <h1 class="text-2xl font-bold mb-4 text-neutral-100">{exampleTitle}</h1>
      <FrameworkTabs currentFramework={framework} example={exampleSlug} />
      <StackBlitzEmbed framework={framework} example={exampleSlug} />
    </main>
  </div>
</Layout>

<script>
  // Framework to App file mapping
  const frameworkAppFiles = {
    react: 'src/App.tsx',
    vue: 'src/App.vue',
    svelte: 'src/App.svelte',
    solid: 'src/App.tsx',
    preact: 'src/App.tsx',
  };

  function getFrameworkFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('framework') ?? 'react';
  }

  function buildStackBlitzUrl(framework, example) {
    const branch = 'master';
    const baseUrl = `https://stackblitz.com/fork/github/andymerskin/spotr/tree/${branch}/examples/${framework}`;
    const params = new URLSearchParams({
      embed: '1',
      view: 'preview',
      hideExplorer: '0',
      startScript: 'dev',
    });
    params.set('initialpath', encodeURIComponent(`?example=${example}`));

    // Add file parameter if we have a mapping for this framework
    const appFile = frameworkAppFiles[framework];
    if (appFile) {
      params.set('file', appFile);
    }

    return `${baseUrl}?${params.toString()}`;
  }

  function updateIframe(framework, example) {
    const iframe = document.getElementById('stackblitz-embed');
    if (iframe) {
      iframe.src = buildStackBlitzUrl(framework, example);
      iframe.setAttribute('data-framework', framework);
      iframe.setAttribute('data-example', example);
    }
  }

  function updateActiveTab(framework) {
    const tabs = document.querySelectorAll('#framework-tabs a');
    tabs.forEach((tab) => {
      const tabFramework = tab.getAttribute('data-framework');
      if (tabFramework === framework) {
        tab.classList.remove('bg-neutral-800', 'border-neutral-600', 'text-neutral-400');
        tab.classList.add('bg-neutral-700', 'border-neutral-500', 'text-neutral-100');
      } else {
        tab.classList.remove('bg-neutral-700', 'border-neutral-500', 'text-neutral-100');
        tab.classList.add('bg-neutral-800', 'border-neutral-600', 'text-neutral-400');
      }
    });
  }

  function handleFrameworkChange() {
    const currentFramework = getFrameworkFromUrl();
    const example = window.location.pathname.split('/').filter(Boolean).pop() || 'fields-basic';
    updateIframe(currentFramework, example);
    updateActiveTab(currentFramework);
  }

  // Handle framework tab clicks
  document.addEventListener('DOMContentLoaded', () => {
    const tabsContainer = document.getElementById('framework-tabs');
    if (tabsContainer) {
      tabsContainer.addEventListener('click', (e) => {
        const target = e.target;
        const link = target.closest('a[data-framework]');
        if (link) {
          e.preventDefault();
          const newFramework = link.getAttribute('data-framework') || 'react';
          const example = window.location.pathname.split('/').filter(Boolean).pop() || 'fields-basic';
          const baseUrl = window.location.origin + window.location.pathname;
          const newUrl = `${baseUrl}?framework=${newFramework}`;
          window.history.pushState({ framework: newFramework }, '', newUrl);
          handleFrameworkChange();
        }
      });
    }

    // Handle browser back/forward navigation
    window.addEventListener('popstate', () => {
      handleFrameworkChange();
    });

    // Initial update in case URL changed after page load
    handleFrameworkChange();
  });
</script>
